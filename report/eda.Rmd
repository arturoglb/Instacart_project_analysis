---
title: "EDA"
author: "Manunpat"
date: '2022-04-23'
output: html_document
---

```{r, echo = FALSE, message = FALSE, warning=FALSE}
source(here::here("scripts/setup.R"))
```

### **Data Description**

`orders` (3.4m rows, 206k users):
* `order_id`: order identifier
* `user_id`: customer identifier
* `eval_set`: which evaluation set this order belongs in (see `SET` described below)
* `order_number`: the order sequence number for this user (1 = first, n = nth)
* `order_dow`: the day of the week the order was placed on
* `order_hour_of_day`: the hour of the day the order was placed on
* `days_since_prior`: days since the last order, capped at 30 (with NAs for `order_number` = 1)

`products` (50k rows):
* `product_id`: product identifier
* `product_name`: name of the product
* `aisle_id`: foreign key
* `department_id`: foreign key

`aisles` (134 rows):
* `aisle_id`: aisle identifier
* `aisle`: the name of the aisle

`deptartments` (21 rows):
* `department_id`: department identifier
* `department`: the name of the department

`order_products__SET` (30m+ rows):
* `order_id`: foreign key
* `product_id`: foreign key
* `add_to_cart_order`: order in which each product was added to cart
* `reordered`: 1 if this product has been ordered by this user in the past, 0 otherwise

where `SET` is one of the four following evaluation sets (`eval_set` in `orders`):
* `"prior"`: orders prior to that users most recent order (~3.2m orders)
* `"train"`: training data supplied to participants (~131k orders)
* `"test"`: test data reserved for machine learning competitions (~75k orders)

#### **Table 1 - aisles**
```{r echo=FALSE, message=FALSE}
aisles <- read.csv(here::here("data/aisles.csv"), header = TRUE)

#missing value
sum(is.na(aisles)) #0

kable(aisles[,], caption = "The aisles table") %>%
  kable_styling(bootstrap_options = "bordered") %>%
  kableExtra::scroll_box(width = "100%", height = "250px")
```

#### **Table 2 - departments**
```{r echo=FALSE, message=FALSE}
departments <- read.csv(here::here("data/departments.csv"), header = TRUE)

#missing value
sum(is.na(departments)) #0

kable(departments[,], caption = "The departments table") %>%
  kable_styling(bootstrap_options = "bordered") %>%
  kableExtra::scroll_box(width = "100%", height = "250px")
```

#### **Table 3 - products**
```{r echo=FALSE, message=FALSE}
products <- read.csv(here::here("data/products.csv"), header = TRUE)

#missing value
sum(is.na(products)) #0

kable(products[1:50,], caption = "The products table") %>%
  kable_styling(bootstrap_options = "bordered") %>%
  kableExtra::scroll_box(width = "100%", height = "250px")
```

#### **Table 4 - order_products_train**
```{r echo=FALSE, message=FALSE}
order_products_train <- read.csv(here::here("data/order_products__train.csv"), header = TRUE)

#missing value
sum(is.na(order_products_train)) #0

kable(order_products_train[1:50,], caption = "The order_products_train table") %>%
  kable_styling(bootstrap_options = "bordered") %>%
  kableExtra::scroll_box(width = "100%", height = "250px")
```

Join table 1, 2, 3 to 4

```{r echo=FALSE, message=FALSE}
main <- order_products_train %>% 
  left_join(products, by = c("product_id")) %>%
  left_join(aisles, by = c("aisle_id")) %>%
  left_join(departments, by = c("department_id"))

str(main)
```

**Top 10 reordered products**

As the result from the table, we can see that fresh fruits and packaged vegetables fruits under produce department are the most reordered products.
```{r echo=FALSE, message=FALSE}
num_reorder_product <- main %>% 
  group_by(product_id, product_name, aisle, department) %>%
  summarise(total_reorder = sum(reordered, na.rm = TRUE), 
            total_order = length(product_id)) %>%
  arrange(desc(total_reorder)) %>%
  mutate(percentage_reorder = (total_reorder/total_order)*100)

kable(num_reorder_product[1:10,], caption = "The top 10 reordered products") %>%
  kable_styling(bootstrap_options = "bordered") %>%
  kableExtra::scroll_box(width = "100%", height = "250px")
```

Overall, approximately 60% of the total orders are reordered products.
```{r echo=FALSE, message=FALSE}
total_percentage_reorder <-
  (sum(num_reorder_product$total_reorder)/sum(num_reorder_product$total_order))*100 
#~60%  
```
 
```{r echo=FALSE, message=FALSE}

fig <- num_reorder_product[1:10,] %>% plot_ly()
fig <- fig %>% add_trace(x = ~reorder(product_name, -total_reorder), 
                         y = ~total_reorder, type = 'bar', 
                         name = "The number of reorder", 
                         textposition = 'auto',
                         offsetgroup = 1,
                         marker = list(color = 'rgb(49,130,189)'))

ay <- list(
  font = list(color = "blue"),
  overlaying = "y",
  side = "right",
  title = "percentage of reorder",
  rangemode = "tozero")

fig <- fig %>% add_trace(x = ~reorder(product_name, -total_reorder), 
                         y = ~percentage_reorder, yaxis = "y2", type = 'bar', 
                         name = "Percentage of reordered products", 
                         textposition = 'auto', 
                         offsetgroup = 2,
                         marker = list(color = 'rgb(204,204,204)'))

fig <- fig %>% layout(title = "The top 10 number of reordered products", yaxis2 = ay, 
                      xaxis = list(title = "", tickangle = -45),
                      yaxis = list(title = "number of reorder"),
         margin = list(b = 100),
         barmode = 'group')

fig

```

**Top 10 reordered products by aisle** 

```{r echo=FALSE, message=FALSE}

num_aisle_product <- main %>% 
  group_by(aisle, department) %>%
  summarise(total_reorder = sum(reordered, na.rm = TRUE), 
            total_order = length(product_id)) %>%
  arrange(desc(total_reorder)) %>%
  mutate(percentage_reorder = (total_reorder/total_order)*100)

kable(num_aisle_product[1:10,], caption = "The top 10 reordered products by aisle") %>%
  kable_styling(bootstrap_options = "bordered") %>%
  kableExtra::scroll_box(width = "100%", height = "250px")
```

```{r echo=FALSE, message=FALSE}

fig <- num_aisle_product[1:10,] %>% plot_ly()
fig <- fig %>% add_trace(x = ~reorder(aisle, -total_reorder), 
                         y = ~total_reorder, type = 'bar', 
                         name = "The number of reorder", 
                         textposition = 'auto',
                         offsetgroup = 1,
                         marker = list(color = 'rgb(49,130,189)'))

ay <- list(
  font = list(color = "blue"),
  overlaying = "y",
  side = "right",
  title = "percentage of reorder",
  rangemode = "tozero")

fig <- fig %>% add_trace(x = ~reorder(aisle, -total_reorder), 
                         y = ~percentage_reorder, yaxis = "y2", type = 'bar', 
                         name = "Percentage of reordered products", 
                         textposition = 'auto', 
                         offsetgroup = 2,
                         marker = list(color = 'rgb(204,204,204)'))

fig <- fig %>% layout(title = "The top 10 number of reordered products by aisle", 
                      yaxis2 = ay, 
                      xaxis = list(title = "", tickangle = -45),
                      yaxis = list(title = "number of reorder"),
         margin = list(b = 100),
         barmode = 'group')

fig

```

**Top 10 reordered products by department**

```{r echo=FALSE, message=FALSE}

num_department_product <- main %>% 
  group_by(department) %>%
  summarise(total_reorder = sum(reordered, na.rm = TRUE), 
            total_order = length(product_id)) %>%
  arrange(desc(total_reorder)) %>%
  mutate(percentage_reorder = (total_reorder/total_order)*100)

kable(num_department_product[1:10,], caption = "The top 10 reordered products by department") %>%
  kable_styling(bootstrap_options = "bordered") %>%
  kableExtra::scroll_box(width = "100%", height = "250px")
```

```{r echo=FALSE, message=FALSE}

fig <- num_department_product[1:10,] %>% plot_ly()
fig <- fig %>% add_trace(x = ~reorder(department, -total_reorder), 
                         y = ~total_reorder, type = 'bar', 
                         name = "The number of reorder", 
                         textposition = 'auto',
                         offsetgroup = 1,
                         marker = list(color = 'rgb(49,130,189)'))

ay <- list(
  font = list(color = "blue"),
  overlaying = "y",
  side = "right",
  title = "percentage of reorder",
  rangemode = "tozero")

fig <- fig %>% add_trace(x = ~reorder(department, -total_reorder), 
                         y = ~percentage_reorder, yaxis = "y2", type = 'bar', 
                         name = "Percentage of reordered products", 
                         textposition = 'auto', 
                         offsetgroup = 2,
                         marker = list(color = 'rgb(204,204,204)'))

fig <- fig %>% layout(title = "The top 10 number of reordered products by department", 
                      yaxis2 = ay, 
                      xaxis = list(title = "", tickangle = -45),
                      yaxis = list(title = "number of reorder"),
         margin = list(b = 100),
         barmode = 'group')

fig

```
#### **Table 5 - order_products__prior**
```{r echo=FALSE, message=FALSE}
order_products_prior <- read.csv(here::here("data/order_products__prior.csv"), header = TRUE)

#missing value
sum(is.na(order_products_prior)) #0

kable(order_products_prior[1:50,], caption = "The order_products_prior table") %>%
  kable_styling(bootstrap_options = "bordered") %>%
  kableExtra::scroll_box(width = "100%", height = "250px")
```

#### **Table 6 - order**
```{r echo=FALSE, message=FALSE}
orders <- read.csv(here::here("data/orders.csv"), header = TRUE)

#missing value
sum(is.na(orders)) #206209

orders %>% filter(eval_set == "prior" | eval_set == "train" ) %>%
  select(-order_id, -user_id, -order_number) %>%
  inspect_num() %>%
  show_plot(col_palette = 3)

```
We can observe on the first chart `days_since_prior_order` that most of the users have a higher probability to do another purchase order after a week from the previous purchase. Also, we can visualize on the graph `oder_dow` that the most frequent days of ordering are Sunday's and Monday's comparing to the rest of the week, and on the last chart `order_hour_of_day`,we note a high demand of orders between 9am to 6pm.

#### **Table 7 - user_purchases**
```{r}
# Combine order product lists to have a global panorama per customer
global_order_prod <- rbind(order_products_prior, order_products_train)

# Identify the products purchased with their departments and the time and day of consumption 
user_purchases <- orders %>%
  left_join(global_order_prod, by = "order_id") %>%
  left_join(products, by = "product_id") %>%
  left_join(aisles, by = c("aisle_id")) %>%
  left_join(departments, by = c("department_id"))

# Divide the user_purchases between training and test sets

user_purchases_tr <- user_purchases %>% filter(eval_set == "train")
plot_intro(user_purchases_tr)
user_purchases_ts <- user_purchases %>% filter(eval_set == "test")
plot_intro(user_purchases_ts)
user_purchases_pr <- user_purchases %>% filter(eval_set == "prior")
```

