---
title: "Untitled"
output: html_document
date: '2022-05-11'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(here::here("scripts/setup.R"))
```

### Culstering

* As the function calculate the distance only can handle 65536 observation, so here only use 1000 or so instance.(try several time, only 1000 can run so far)
* already drop the colomn of day of week and hour of day. more normal than before.  

```{r}
library(fastDummies)
department_wide.tr <- read.csv(here::here("data/department_wide.tr2.csv")) %>%
  select(-X, -order_id, -order_dow, -order_hour_of_day)

row.names(department_wide.tr) <- paste("O", c(1:nrow(department_wide.tr)), sep="") 
```


#### Hierarchical clustering

```{r}
# department_wide.tr$order_dow <- as.factor(department_wide.tr$order_dow)
# department_wide.tr$order_hour_of_day <- as.factor(department_wide.tr$order_hour_of_day)
# 
# department_wide.dummy <- department_wide.tr %>%
#   select(order_dow, order_hour_of_day) %>% dummy_cols(remove_first_dummy = F)
# 
# department_wide.tr <- department_wide.tr %>%
#   cbind(department_wide.dummy) %>% 
#   select(-order_dow, -order_hour_of_day)
```

- distance  
```{r}
library(reshape2)
department.d <- dist(department_wide.tr, method = "manhattan") 

department.melt <- melt(as.matrix(department.d))
head(department.melt)
```

- Dendrogram  

```{r}
department.hc <- hclust(department.d, method = "complete")
plot(department.hc, hang=-1)
```

- Choice of the number of clusters  

- manhattan, wss  

```{r}
library(factoextra)

fviz_nbclust(department_wide.tr,
             hcut, hc_method="complete",
             hc_metric="manhattan",
             method = "wss", 
             k.max = 25, verbose = FALSE)
```

- manhattan, silhouette  

```{r}
fviz_nbclust(department_wide.tr,
             hcut, hc_method="complete",
             hc_metric="manhattan",
             method = "silhouette", 
             k.max = 25, verbose = FALSE)
```

- manhattan, gap   

```{r}
fviz_nbclust(department_wide.tr,
             hcut, hc_method="complete",
             hc_metric="manhattan",
             method = "gap", 
             k.max = 25, verbose = FALSE)
```


```{r}
plot(department.hc, hang=-1)
rect.hclust(department.hc, k=3)
```

```{r}
department.clust <- cutree(department.hc, k=3)

```

```{r}
department.comp <- data.frame(department_wide.tr, Clust=factor(department.clust), Id=row.names(department_wide.tr))
department.df <- melt(department.comp, id=c("Id", "Clust"))
head(department.df)
```
- Interpretation of the clusters
```{r, fig.height=20, fig.width=20}
ggplot(department.df, aes(y=value, group=Clust, fill=Clust)) +
  geom_boxplot() +
  facet_wrap(~variable, scale='free')
```



#### K-means

- WSS 
```{r}
library(factoextra)
fviz_nbclust(department_wide.tr,
             kmeans,
             method = "wss", 
             k.max = 25, verbose = FALSE)

```

- silhouette
```{r}
fviz_nbclust(department_wide.tr,
             kmeans, 
             method = "silhouette", 
             k.max = 25, verbose = FALSE)
```

- gap  
```{r}
fviz_nbclust(department_wide.tr,
             kmeans,
             method = "gap", 
             k.max = 25, verbose = FALSE)
```

```{r}
department.kmeans <- kmeans(department_wide.tr, 3)
department.kmeans
```

```{r}
library(ggfortify)
autoplot(kmeans(department_wide.tr, 3),data=department_wide.tr,label=T, label.size=2, frame=TRUE)
```


#### PAM

- drop if no day of week, hour of day
```{r}
# library(fastDummies)
# 
# order.times <- user_purchases%>%
#   group_by(order_dow, order_hour_of_day, department) %>%
#   summarise(departmentindetail=n())
# 
# order.times$order_dow <- as.factor(order.times$order_dow)
# order.times$order_hour_of_day <- as.factor(order.times$order_hour_of_day)
# 
# data.clustering <- order.times %>%
#   select(order_dow, order_hour_of_day) %>%
#   dummy_cols() %>%
#   cbind(order.times)
#   


```

```{r}
# fviz_nbclust(department_wide.tr,
#              cluster::pam,
#              method = "wss",
#              k.max = 25, verbose = FALSE)

fviz_nbclust(department_wide.tr,
             cluster::pam,
             method = "silhouette", 
             k.max = 25, verbose = FALSE)

# fviz_nbclust(department_wide.tr,
#              cluster::pam,
#              method = "gap",
#              k.max = 25, verbose = FALSE)
```
##### only can run 1000 successful, the function only can have 65536 observation

```{r}
library(cluster)

department_wide.tr.pam <- pam(department_wide.tr, k=2)
plot(department_wide.tr.pam)
```

cannot show up